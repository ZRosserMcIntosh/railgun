# RAILGUN PROMETHEUS CONFIGURATION
# Doctrine-compliant: metrics only, no content inspection

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'railgun-prod'
    env: '${ENVIRONMENT:-development}'

# Alerting configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# Load alert rules
rule_files:
  - /etc/prometheus/alerts.yml

# Scrape configurations
scrape_configs:
  # ============================================
  # PROMETHEUS SELF-MONITORING
  # ============================================
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # ============================================
  # RAILGUN API SERVERS
  # ============================================
  - job_name: 'railgun-api'
    metrics_path: /metrics
    static_configs:
      - targets: ['host.docker.internal:9464']
        labels:
          service: 'api'
          layer: 'business'  # DOCTRINE: Business layer only
    # Service discovery for Kubernetes
    # kubernetes_sd_configs:
    #   - role: pod
    #     namespaces:
    #       names: ['railgun']
    # relabel_configs:
    #   - source_labels: [__meta_kubernetes_pod_label_app]
    #     regex: railgun-api
    #     action: keep

  # ============================================
  # OPENTELEMETRY COLLECTOR
  # ============================================
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['otel-collector:8888']
        labels:
          service: 'otel-collector'

  # ============================================
  # INFRASTRUCTURE METRICS
  # ============================================
  - job_name: 'postgres'
    static_configs:
      - targets: ['host.docker.internal:9187']  # postgres_exporter
        labels:
          service: 'postgres'
          layer: 'infrastructure'

  - job_name: 'redis'
    static_configs:
      - targets: ['host.docker.internal:9121']  # redis_exporter
        labels:
          service: 'redis'
          layer: 'infrastructure'

  # ============================================
  # NODE METRICS (if node_exporter is running)
  # ============================================
  - job_name: 'node'
    static_configs:
      - targets: ['host.docker.internal:9100']
        labels:
          layer: 'infrastructure'

  # ============================================
  # JAEGER METRICS
  # ============================================
  - job_name: 'jaeger'
    static_configs:
      - targets: ['jaeger:14269']
        labels:
          service: 'jaeger'

# DOCTRINE COMPLIANCE NOTE:
# - We scrape ONLY business metrics (request counts, latencies, errors)
# - No user identifiers in labels
# - No message content in any metric
# - All user-related metrics are aggregates (counts, histograms)
